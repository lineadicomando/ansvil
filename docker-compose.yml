services:

  core:
    image: docker.io/lineadicomando/ansvile-core:${VERSION:-latest}
    container_name: ansvil-core
    hostname: ansvil-core
    depends_on:
      - semaphore-db
    network_mode: host
    volumes:
      - ./core/scripts:/scripts:z
      - ${ANSVIL_PROJECTS_VOLUME_PATH}:${ANSVIL_PROJECTS_PATH}:z
      - ${ANSVIL_DATA_VOLUME_PATH}/entrypoint.d:/entrypoint.d:z
      - ${ANSVIL_DATA_VOLUME_PATH}/ansvil/config:/home/ansvil/.config:z
      - ${ANSVIL_DATA_VOLUME_PATH}/ansvil/bashrc.d:/home/ansvil/.bashrc.d:z
      - ${ANSVIL_DATA_VOLUME_PATH}/ansvil/local/share/code-server:/home/ansvil/.local/share/code-server:z
    entrypoint: ["/bin/bash", "/scripts/entrypoint-wrapper.sh"]      
    environment:
      - ANSVIL_USER=ansvil
      - ANSVIL_USER_HOME=/home/ansvil
      - ANSVIL_PROJECTS_PATH=${ANSVIL_PROJECTS_PATH}
      - CODE_SERVER_BIND_ADDR=${CODE_SERVER_BIND_ADDR}
      - CODE_SERVER_DEFAULT_PASSWORD=${CODE_SERVER_DEFAULT_PASSWORD}
      - SEMAPHORE_DB_HOST=${SEMAPHORE_DB_HOST}
      - SEMAPHORE_DB_PORT=${SEMAPHORE_DB_PORT}
      - SEMAPHORE_DB_NAME=${SEMAPHORE_DB_NAME}
      - SEMAPHORE_DB_USER=${SEMAPHORE_DB_USER}
      - SEMAPHORE_DB_PASS=${SEMAPHORE_DB_PASS}
      - SEMAPHORE_ADMIN_USER=${SEMAPHORE_ADMIN_USER}
      - SEMAPHORE_ADMIN_DEFAULT_PASSWORD=${SEMAPHORE_ADMIN_DEFAULT_PASSWORD}
      - SEMAPHORE_ADMIN_NAME=${SEMAPHORE_ADMIN_NAME}
      - SEMAPHORE_ADMIN_EMAIL=${SEMAPHORE_ADMIN_EMAIL}
    restart: unless-stopped

  semaphore-db:
    image: mariadb:10.11
    container_name: ansvil-semaphore-db
    environment:
      - MARIADB_ROOT_PASSWORD=${SEMAPHORE_DB_ROOT_PASSWORD}
      - MARIADB_DATABASE=${SEMAPHORE_DB_NAME}
      - MARIADB_USER=${SEMAPHORE_DB_USER}
      - MARIADB_PASSWORD=${SEMAPHORE_DB_PASS}
    volumes:
      - ${SEMAPHORE_VOLUME_PATH}:/var/lib/mysql:z
    network_mode: host
    restart: unless-stopped

  front:
    image: nginx:stable
    container_name: ansvil-proxy
    hostname: ansvil-proxy
    entrypoint: [ "/bin/sh", "/entrypoint.sh" ]
    volumes:
      - ./front/reverse-proxy.conf:/etc/nginx/conf.d/default.conf:ro,z
      - ./front/entrypoint.sh:/entrypoint.sh:ro,z
      - ./front/html:/usr/share/html:z
      - ./data/ssl/certs:/etc/ssl/certs:z
      - ./data/ssl/private:/etc/ssl/private:z
    depends_on:
      - core
    network_mode: host
    environment:
      - SSL_DAYS=${SSL_DAYS}
      - SSL_C=${SSL_C}
      - SSL_ST=${SSL_ST}
      - SSL_L=${SSL_L}
      - SSL_O=${SSL_O}
      - SSL_CN=${SSL_CN}
    restart: unless-stopped
